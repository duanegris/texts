<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>TD SOAP</title>

<style type="text/css">

.innerbox {margin: 25pt;
	     padding:10pt;
	     background-color:#fffffd;
	     border : solid black 1px;
	}

</style>
</head>
<body>

<div class="innerbox">

<i>Note</i>: les exercices demandent d'écrire les programmes princpalement en PHP. Vous pourrez vous aider
des explications suivantes sur les tableaux en PHP si vous en avez besoin:
<a href="http://icps.u-strasbg.fr/~genaud/courses/webtech/php/ch03.html#id2608323">
http://icps.u-strasbg.fr/~genaud/courses/webtech/php/ch03.html#id2608323</a>.


<h1>Utilisation d'un service commercial de géolocalisation</h1>

<p>
La société <a href="http://www.fraudlabs.com">FraudLabs</a> propose un ensemble (payants) de services web
ayant trait &agrave; la géo-localisation. Ceux-ci peuvent par exemple être utilisés pour 
vérifier la validité d'une adresse saisie par un client, pour localiser géographiquement
un client d'après l'IP de sa machine, ...
</p>
<p>

</p>



On souhaite utiliser le service de Géolocalisation qui à une adresse IP rend les coordonnées géographiques (lattitude, longitude) de la machine.
Examiner la description WSDL du service :
<a href="http://v1.fraudlabs.com/fraudlabswebservice.asmx?wsdl">
http://v1.fraudlabs.com/fraudlabswebservice.asmx?wsdl
</a>
	
<ol>
	<li><i>Analyse du WSDL</i>
	<ul>
		<li>Cherchez le nom de la méthode unique proposée par ce service.
		<!--  <operation name="FraudLabs"> -->
		</li>
		<li>Cherchez les entrées et sorties de cette méthode.

		<!-- Cette operation a comme entree et sortie
			<input message="tns:FraudLabsRequest"/>
			<output message="tns:FraudLabsResponse"/>
		-->

	
		Quel est le nom des entrées, quel est le nom des sorties ?
		<!-- <wsdl:types> 
			in = <s:element name="IP2Location">
			out = <s:element name=IP2LocationResponse">
		-->
		</li>
		<li>
		<li>
		Quels sont les paramètres (nom et types) qui composent l'entrée ?
		<!--	En regardant la definition deis messages entrees et sorties, 
			on trouve pour les entrées:
				<part name="inputdata" type="tns:FraudLabsInput"/>
			  qui pointe vers le complexType :
				<xsd:complexType name="FraudLabsInput">
					<xsd:all>
						<xsd:element name="IP" type="xsd:string" minOccurs="0" maxOccurs="1"/>
						...

			Tous les paramètres sont optionnels (minOccurs="0")
			mais il faut bien renseigner IP et LICENSE pour que le service reponde.
		-->
		</li>
        	</li>
		<li>
		A quels noms de champs le type de la sortie fait il référence ?
		<!--
		<xsd:complexType name="FraudLabsOutput">
		<xsd:all>
		<xsd:element name="COUNTRYMATCH" type="xsd:string" minOccurs="0" maxOccurs="1"/>
		<xsd:element name="COUNTRY" type="xsd:string" minOccurs="0" maxOccurs="1"/>
		<xsd:element name="HIGHRISKCOUNTRY" type="xsd:string" minOccurs="0" maxOccurs="1"/>
		<xsd:element name="DISTANCE" type="xsd:string" minOccurs="0" maxOccurs="1"/>
		<xsd:element name="IP2COUNTRY" type="xsd:string" minOccurs="0" maxOccurs="1"/>
		<xsd:element name="IP2REGION" type="xsd:string" minOccurs="0" maxOccurs="1"/>
		<xsd:element name="IP2CITY" type="xsd:string" minOccurs="0" maxOccurs="1"/>
		<xsd:element name="IP2LATITUDE" type="xsd:string" minOccurs="0" maxOccurs="1"/>
		<xsd:element name="IP2LONGITUDE" type="xsd:string" minOccurs="0" maxOccurs="1"/>
		<xsd:element name="IP2ISP" type="xsd:string" minOccurs="0" maxOccurs="1"/>
		<xsd:element name="ANONYMOUSPROXY" type="xsd:string" minOccurs="0" maxOccurs="1"/>
		<xsd:element name="FREEMAIL" type="xsd:string" minOccurs="0" maxOccurs="1"/>
		<xsd:element name="BINCOUNTRYMATCH" type="xsd:string" minOccurs="0" maxOccurs="1"/>
		<xsd:element name="BINNAMEMATCH" type="xsd:string" minOccurs="0" maxOccurs="1"/>
		<xsd:element name="BINPHONEMATCH" type="xsd:string" minOccurs="0" maxOccurs="1"/>
		<xsd:element name="BINCOUNTRY" type="xsd:string" minOccurs="0" maxOccurs="1"/>
		<xsd:element name="BINBANKNAME" type="xsd:string" minOccurs="0" maxOccurs="1"/>
		<xsd:element name="BINBANKPHONE" type="xsd:string" minOccurs="0" maxOccurs="1"/>
		<xsd:element name="POSTALCITYMATCH" type="xsd:string" minOccurs="0" maxOccurs="1"/>
		<xsd:element name="PHONECITYMATCH" type="xsd:string" minOccurs="0" maxOccurs="1"/>
		<xsd:element name="SHIPFORWARD" type="xsd:string" minOccurs="0" maxOccurs="1"/>
		<xsd:element name="CREDITSAVAILABLE" type="xsd:string" minOccurs="0" maxOccurs="1"/>
		<xsd:element name="FRAUDSCORE" type="xsd:string" minOccurs="0" maxOccurs="1"/>
		<xsd:element name="QUERYID" type="xsd:string" minOccurs="0" maxOccurs="1"/>
		<xsd:element name="MESSAGE" type="xsd:string" minOccurs="0" maxOccurs="1"/>
		</xsd:all>
		</xsd:complexType>

     		-->
		</li>
	</ul>
	<li><i>Ecriture d'un client PHP :</i>
	<ul>
		<li>Demander un numéro de license gratuit : <a href="http://www.fraudlabs.com/freelicense.aspx?PackageID=1">http://www.fraudlabs.com/freelicense.aspx?PackageID=1</a>.</li>
		<li>Vous disposez d'un interpréteur PHP5 (taper <tt>php</tt> ou <tt>php5</tt>) compilé avec le support SOAP (taper  <tt>php -i</tt> pour le vérifier).</li>
		<li>Appeler le web-service: construisez un tableau associatif pour les paramètres d'entrée ("IP" et "LICENSE").</li>
		<!-- array("IP" => "130.79.192.160", "LICENSE" => "OA-457-....") -->

		<li>Afficher la réponse: si le champ <tt>Message</tt> n'est pas vide, afficher les valeurs de latitude, longitude, sinon afficher l'erreur.
		<!-- 
	   	$result = $SoapResponse -> GetLocationByIPResult;
	   	if (!isset($result->Message)) {
     			 print("IP $query localisee aux coordonnees geographiques (lat,lon) : ".$result->LATITUDE ."°,". $result->LONGITUDE."°\n");
   	   	}
   	   	else
      		print("Erreur : " . $result->Message . "\n");

		_________________
		programme complet: http://icps.u-strasbg.fr/~genaud/courses/sd/src/soap/php/ip2location_wsdl.php.txt
			
		-->
	</ul>
</ol>


<h1>Utilisation d'un dictionnaire</h1>

<p>
Recherche dans des dictionnaires. 
Le noeud SOAP <a href="http://services.aonaware.com/DictService/DictService.asmx">
http://services.aonaware.com/DictService/DictService.asmx
</a> fournit différents services.
On souhaite utiliser la méthode Define qui rend la définition d'un mot anglais.
</p>
<ol>
	<li>Le paramètre d'entrée de Define est une chaine unique (word).
	Schématiser la structure (imbrication des champs) de la réponse.</li>
	<!--
		DefineResult
			Word
			Definitions
				Definition
				Word
				Dictionnary
					Id
					Name
	-->
	<li>Ecrire un client PHP qui utilise cette méthode. 
Vous pouvez utiliser le WSDL disponible : <a href="http://services.aonaware.com/DictService/DictService.asmx?WSDL">
http://services.aonaware.com/DictService/DictService.asmx?WSDL
</a>.
(Conseil : vous devrez utiliser 3 niveaux d'itérations pour parcourir le résultat contenu dans <tt>DefineResult</tt> ; la primitive <tt>foreach ($tableau as $cle =&gt; $val) {}</tt> est adéquate pour cela. La primitive <tt>var_dump($variable)</tt> ou <tt>print_r($variable)</tt> est également d'un grand secours pour analyser la structuration des données générée par la classe SoapClient).</li>
	<!--

		Reponse (principe d'acces aux donnees) : 
		________________________________________
            Une fois l'objet de la classe Soapclient construit avec l'url du wsdl,
            ...
		$SoapResponse = $SoapClient->Define(array("word" => "Moon"));
            ...
            on peut par exemple acceder au mot de recherche rendu par le service (Word) par :
            ...
	      $Result = $SoapResponse->DefineResult;
	      echo "-> Resultat pour $Result->Word :\n";
            ...
            on peut acceder au nom du dictionnaire utilise pour la premiere definition retournee par :
		$DicoDef1 = $Result->Definitions->Definition[0]->Dictionary->Name;
		_____________________	

		programme complet : http://icps.u-strasbg.fr/~genaud/courses/sd/src/soap/php/DictService_wsdl.php.txt
	-->
	<li>Question subsidiaire: Ecrire un client SOAP::Lite qui utilise cette méthode.</li>
</ol>



<h1>Utilisation d'un service commercial d'envoi de SMS</h1>

<p>
La société <a href="http://www.esendex.com/">Esendex</a> propose un services web
permettant l'envoi massif de SMS.
</p>
<p>
Le service est à <a href="https://www.esendex.com/secure/messenger/soap/SendService.asmx">
https://www.esendex.com/secure/messenger/soap/SendService.asmx
</a>
</p>


<ol>
	<li><i>Analyse du WSDL</i>

Analyser le WSDL situé à:
<a href="https://www.esendex.com/secure/messenger/soap/SendService.asmx?WSDL">
https://www.esendex.com/secure/messenger/soap/SendService.asmx?WSDL
</a>

	<!--
		Aide pour analyser le WSDL avec votre programme PHP
		___________________________________________________
	
		$wsdl_url = "https://www.esendex.com/secure/messenger/soap/SendService.asmx?WSDL";
   		$c = new SoapClient($wsdl_url, array("trace"=>1));

		/* To analyze the WSDL, you can call the following useful functions */

   		print_r( $c->__getFunctions());
   		print_r( $c->__getTypes());


		/* The services expects to receive crendentials in the header 
   		It waits for :
 
		<soap:Header>
  			  <MessengerHeader xmlns="com.esendex.ems.soapinterface">
     				 <Username>string</Username>
     			 	<Password>string</Password>
      			<Account>string</Account>
    			  </MessengerHeader>
  		</soap:Header>
		*/
	-->



	</li>
	<li>
		Ecrire le programme PHP construisant l'appel de la méthode <tt>SendMessageFull()</tt>.
		Pour faire des tests, vous aurez besoin d'un compte utilisateur avec mot de passe
		que je fournirai après vérification du code, le nombre d'essais associé au compte étant
		limité. 
	</li>
	
	<!--	

		$account="EX0071093";
		$username="genaud@unistra.fr";
		$password= ASK ME !!
		$recipient="0033686267449";  /* use intl telephone numbers ! */
		$originator="0686267449"; /* any number to identify sender */
		$body="Ceci est mon test d'envoi de SMS";
		$type="Text"; /* can be : Text, Binary, SmartMessage, Unicode. Default is Text */
		$validityperiod="0"; /* validity in hours. 0 means never expires */


		 $header = new SOAPHeader("com.esendex.ems.soapinterface",
				"MessengerHeader", 
				array(
					"Username"=> $username,
					"Password"=> $password,
					"Account"=>$account)
				);
   		$c -> __setSoapHeaders( $header );

		/* Now call te function 'SendFullMessage' */
   		try {
			$c->SendMessageFull(array(
					"originator" => $originator, 
					"recipient"=> $recipient,
					"body"=> $body,
					"type"=> $type,
					"validityperiod"=> $validityperiod,
				));
   		}
   		catch (SoapFault $fault) {
			die( $fault->faultstring);
   		}


	-->


</div> <!-- innerbox -->
</body>
</html>

