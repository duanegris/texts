<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN""http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>Insertion de données dans la base</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REL="HOME"
TITLE="Notes de cours Apache+PHP+MySQL"
HREF="index.html"><LINK
REL="UP"
TITLE="Accéder à une base MySQL avec PHP"
HREF="c466.html"><LINK
REL="PREVIOUS"
TITLE="Lecture et affichage HTML des données"
HREF="x479.html"><LINK
REL="NEXT"
TITLE="Gérer plusieurs tables"
HREF="x577.html"></HEAD
><BODY
CLASS="sect1"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>Notes de cours Apache+PHP+MySQL</TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="x479.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
>Chapter 5. Accéder à une base MySQL avec PHP</TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="x577.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="sect1"
><H1
CLASS="sect1"
><A
NAME="AEN528"
>5.3. Insertion de données dans la base</A
></H1
><P
>&#13;Pour la mise à jour de la base nous avons besoin de deux fichiers :
un premier fichier qui doit contenr un formulaire HTML dans lequel l'internaute
peut saisir les données à insérer dans la base, et un deuxième fichier
(PHP) qui permette de récupérer les données du formulaire pour les insérer dans
la base.
</P
><DIV
CLASS="sect2"
><H2
CLASS="sect2"
><A
NAME="AEN531"
>5.3.1. Saisie des données (formulaire)</A
></H2
><P
>&#13;Ici, le fichier peut être un simple fichier HTML, puisque toues les éléments de la page sont statiques.
Nous l'appelons <TT
CLASS="filename"
>saisie.html</TT
>. 
Notez que la mise en page HTML est des
plus sommaires, ceci afin d'améliorer la lisibilité et se concentrer
sur les éléments importants du code.
<PRE
CLASS="programlisting"
>&#13;&#60;html&#62;
&#60;body&#62;
&#60;h1&#62;Mise à jour de la base&#60;/h1&#62;
&#60;form method="post" action="maj.php"&#62;
Référence : &#60;input type="text" name="ref"&#62;&#60;br&#62;
Nom       : &#60;input type="text" name="nom"&#62;&#60;br&#62;
Prix      : &#60;input type="text" name="prix"&#62;&#60;br&#62;
            &#60;input type=submit value="Insérer"&#62;
&#60;/form&#62;
&#60;/body&#62;
&#60;/html&#62;
</PRE
>
</P
><P
>&#13;
Il est important de remarquer la partie <CODE
CLASS="function"
>action</CODE
>
du formulaire. C'est ici qu'on précise quel programme doit
récupérer les données du formulaire et les traiter.
Dans notre cas, il s'agit du fichier <TT
CLASS="filename"
>maj.php</TT
>,
qui sera chargé lorsque le bouton de type <CODE
CLASS="function"
>submit</CODE
>
sera pressé.
</P
><P
>&#13;
Rappelons que toute cette section ne présente que des éléments connus
d'un programmeur HTML. Rien de nouveau !

</P
></DIV
><DIV
CLASS="sect2"
><H2
CLASS="sect2"
><A
NAME="AEN541"
>5.3.2. Récupération des valeurs du formulaire HTML en PHP</A
></H2
><P
>&#13;
Nous voulons mainteant récupérer les données du formulaires pour les insérer dans la base. 
Avant de l'écrire, il est d'abord nécessaire de savoir comment sont transmises
les données du formulaire à notre nouveau fichier (celui désigné par l'attribut <B
CLASS="command"
>action</B
>
dans le formulaire précédent), et comment on peut récupérer ces valeurs en PHP.
</P
><P
>&#13;Techniquement, le formulaire HTML est <SPAN
CLASS="emphasis"
><I
CLASS="emphasis"
>posté</I
></SPAN
> lorsque l'utilisateur appuie sur le bouton de type <B
CLASS="command"
>submit</B
>.
Ceci veut dire qu'une requête HTTP de type POST est émise vers le serveur, et cette requête contient les valeurs du formulaire. 
La forme sous laquelle sont transmises les valeurs est une suite de copules (<B
CLASS="command"
>variable</B
> = <B
CLASS="command"
>valeur</B
>).
</P
><P
>&#13;PHP récupère ses requête dans un tableau nommé <B
CLASS="command"
>$_POST</B
>, dont les index de tableaux sont les noms des variables (voir le paragraphe sur les tableaux associatifs en PHP). 
Il est donc facile de retrouver la valeur associée à une variable.
Par exemple, <B
CLASS="command"
>$_POST['prix']</B
> désigne la valeur associée à prix dans le formulaire posté.
</P
><DIV
CLASS="tip"
><P
></P
><TABLE
CLASS="tip"
WIDTH="100%"
BORDER="0"
><TR
><TD
WIDTH="25"
ALIGN="CENTER"
VALIGN="TOP"
><IMG
SRC="../images/tip.gif"
HSPACE="5"
ALT="Tip"></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>&#13;Dans les anciennes configurations de PHP (avant PHP 4.2.0), il n'était pas nécessaire de récupérer explicitement les variables postées. 
PHP créait automatiquemlent des variables PHP de même nom que les champs déclarés dans le forumaire HTML. 
Ainsi, on récupère la valeur du champ <B
CLASS="command"
>&#60;input type="text" name="prix"&#62;</B
> du formulaire dans une variable <B
CLASS="command"
>$prix</B
>.
Ce mode aujourd'hui désactivé pour des raisons de sécurité, peut être rétabli
en écrivant <B
CLASS="command"
> register_globals = On </B
> dans le fichier <TT
CLASS="filename"
>php.ini</TT
>.
</P
></TD
></TR
></TABLE
></DIV
></DIV
><DIV
CLASS="sect2"
><H2
CLASS="sect2"
><A
NAME="AEN559"
>5.3.3. Ecriture des données</A
></H2
><P
>&#13;	  Maintenant que nous savons récupérer les valeurs des variables du formulaire, il faut les sauvegarder dans la base de données.
</P
><P
>&#13;Nous écrivons un deuxième fichier, que nous appelons <TT
CLASS="filename"
>maj.php</TT
>.
Voyons le listing de notre fichier. 
On retrouve les instructions de connexion à la base, comme dans
<A
HREF="x479.html#lecture"
>Section 5.2.1</A
>. 
Sur le principe, seule la requête SQL change, avec un 
<CODE
CLASS="function"
>insert</CODE
> au lieu d'un <CODE
CLASS="function"
>select</CODE
>.

<PRE
CLASS="programlisting"
>&#13;&#60;html&#62;
&#60;body&#62;
&#60;?
// connexion à la base
mysql_connect("localhost","root","") or die ("Impossible de se connecter");
mysql_select_db("base") or die("Impossible de trouver la base");           

// recuperation des valeurs du formulaire
$nom = $_POST['nom'];
$prix= $_POST['prix'];

// insertion des valeurs dans la base
$query = "insert into produit (nom,prix) values ('$nom','$prix')";
$result=mysql_query($query);
mysql_close();
?&#62;
Mise a jour faite
&#60;/body&#62;
&#60;/html&#62;
</PRE
>

Ici, on suppose toujours que <CODE
CLASS="varname"
>ref</CODE
> est une clé primaire
de la table produit, et qu'elle possède en plus la propriété <B
CLASS="command"
>&#13;autoincrement</B
>. 
Ainsi, nous n'avons pas à gérer l'unicité de la référence, puisque MySQL
inserera automatiquement une référence entière supérieure aux autres références
trouvées.

</P
></DIV
><DIV
CLASS="sect2"
><H2
CLASS="sect2"
><A
NAME="AEN570"
>5.3.4. Modification de données</A
></H2
><P
>&#13;La modification de données (on dit encore la mise a jour, ou le remplacement de valeur)
peut porter sur une ou plusieurs lignes, d'une ou plusieurs tables.
La modification est introduite par la requête SQL :
<PRE
CLASS="programlisting"
>&#13;    replace into table 
           (champ1,champ2,...) 
    where  (conditions)
    values (val1,val2,...);
</PRE
>
qui remplace les valeurs présentes dans champ1 par val1, champ2 par val2, etc.
</P
><P
> 
Commençons par le cas simple : modifier les valeurs d'une seule ligne.
On veut par exemple modifier le prix d'un article de notre exemple précédent.
On utilise ici la clé primaire <CODE
CLASS="varname"
>ref</CODE
>, unique qui a pour conséquence que
le remplacement ne se fait que sur une ligne.
<PRE
CLASS="programlisting"
>&#13;$query = "replace into produit (ref,prix) values ('$ref','$nouveau_prix')";
echo "Le prix de l'article $ref est modifié .."; 
</PRE
>

</P
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="x479.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="x577.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Lecture et affichage HTML des données</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="c466.html"
ACCESSKEY="U"
>Up</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Gérer plusieurs tables</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>